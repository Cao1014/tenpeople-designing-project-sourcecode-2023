# STM32 主控开发

## 1. 项目简介

在项目中,STM32主控主要用于连接、控制各种设备，并读取部分设备的返回值；起到了控制整个系统的作用。这部分工作主要由孙林涵和陈曦完成。

## 2. 基础功能

### a. 控制电机驱动板

电机驱动板（H7XX）通过串口（UART）与主控通信，主控通过串口发送指令给电机驱动板。指令的格式为1231231234，以ASCII编码方式发送；其中前三位指示x方向速度，中间三位指示y方向速度，后四位指示角速度；三个速度的第一位是符号位，0代表负\左，1代表正\右；三个速度的后几位是数值，其中x，y的数值位有两位，角速度的数值位有三位，这是因为角速度的单位较小，需要较大的数值来控制。

在代码中，为了便于协作，将控制电机驱动板的功能封装成了数个函数，如Forward(91)是将x方向速度的符号位设定为1，两个数据位设定为9和1。重复上述内容，当x速度，y速度和角速度都设置完成后，再调用drive()函数，将数据发送给电机驱动板。

### b. 控制与读取超声波传感器

超声波传感器通过两个端口与主控通信：Trig端口用于由主控发送触发信号，启动一次测距；Echo端口用于传感器返回距离值。当Trig端口的高电平信号持续10ms以上时，传感器启动一次测距，并记录声波从发出到返回传感器的时间，然后将Echo端口的电平置高，持续的时间就是声波的往返时间，通过声波的速度（340m/s）和时间，就可以计算出距离。在实际应用时，小车共安装了三个超声波传感器，分别用于测量前方、右前和右后的距离，它们的Trig端口并联在一起，接受相同的触发信号，这样做简化了电路设计，降低了系统资源占用；而返回值发送至主控的不同端口处理。

在主控端，为了降低系统资源占用，采用了定时器（Timer）中断（Interrupt，or in short IT）的方式来读取Echo端口的高电平时间；采用了定时器（Timer）生成PWM信号的方式来发送Trig端口的高电平信号。具体配置数据可见[wiki](https://github.com/ray24777/tdps2023/wiki/%E8%B6%85%E5%A3%B0%E6%B3%A2%E6%B5%8B%E8%B7%9D-STM32%E5%AE%9E%E7%8E%B0-%E4%BE%A7%E9%9D%A2%E5%AF%B9%E9%BD%90)。

### c. HC-12 无线模块

HC-12通过串口与主控连接。根据刘策含的实验，HC-12启动后即自动配对并进入透传（串口发送给HC-12的值，会由HC-12原封不动地发射为无线电信号）模式。因此，只需要由串口发送任一约定好的keyword，即可触发接收端的任务。

以下内容由陈曦完成。
### d. 读取陀螺仪

### e. 控制舵机

## 3. 进阶功能

### 实现与栏杆对齐

在读取右前，右后侧的距离后，数据被用于与栏杆对齐。在Alignment函数中，进行了两次PID控制：一是计算右前、右后距离的平均值，从而得出小车距离栏杆的距离，通过PID控制y方向的速度，保证小车一直与栏杆保持一定距离；二是计算右前、右后距离的差值，从而得出小车与栏杆的角度，通过PID控制角速度，保证小车一直与栏杆保持相对平行的角度。

PID算法直接采用了[开源PID库](https://github.com/Majid-Derhambakhsh/PID-Library)，简化了开发难度，通过调整PID初始化函数的参数，即可控制Kp，Ki，Kd的值。

